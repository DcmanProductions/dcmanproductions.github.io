/* LFInteractive LLC. All Rights Reserved */
$(document).on("nav-complete",()=>{Array.from($("video-player")).forEach(e=>{new VideoPlayer({allowAudioModulation:null!=$(e).attr("allowAudioModulation"),allowFullscreen:null!=$(e).attr("allowFullscreen"),allowSeek:null!=$(e).attr("allowSeek"),loop:null!=$(e).attr("loop"),allowKeyboardShortcuts:null!=$(e).attr("allowKeyboardShortcuts"),id:e.id,classes:Array.from(e.classList),poster:$(e).attr("poster"),header:{title:$(e).attr("title"),subtitle:$(e).attr("subtitle"),date:new Date(Number.parseInt($(e).attr("year")),Number.parseInt($(e).attr("month")),Number.parseInt($(e).attr("day")))},speedOptions:Array.from((null==$(e).attr("speeds")?"":$(e).attr("speeds")).split(",")),qualityOptions:[{src:$(e).attr("src"),name:"Full-HD",width:1920,height:1080,bitrate:15e5,default:!0}]}).replaceElement(e)})});class VideoPlayer{defaultOptions={id:`player-${btoa((new Date).getTime()+"").replaceAll("==","")}`,classes:[""],poster:"",allowFullscreen:!0,allowAudioModulation:!0,allowSeek:!0,allowKeyboardShortcuts:!0,loop:!1,header:{title:"",subtitle:"",date:new Date},speedOptions:[.25,.5,.75,1,1.25,1.5,1.75,2],qualityOptions:[{src:"",name:"",width:0,height:0,bitrate:0,default:!1}]};constructor(e=this.defaultOptions){if(this.speed=1,null!=e.qualityOptions&&0!=e.qualityOptions.length){if(1==e.qualityOptions.length)this.source=e.qualityOptions[0];else{for(let t=0;t<e.qualityOptions.length;t++)if(e.qualityOptions[t].default){this.source=e.qualityOptions[t];break}null==this.source&&(this.source=e.qualityOptions[0])}e!==this.defaultOptions&&(e.allowFullscreen=null==e.allowFullscreen?this.defaultOptions.allowFullscreen:e.allowFullscreen,e.id=null==e.id||""==e.id?this.defaultOptions.id:e.id,e.allowAudioModulation=null==e.allowAudioModulation?this.defaultOptions.allowAudioModulation:e.allowAudioModulation,e.allowSeek=null==e.allowSeek?this.defaultOptions.allowSeek:e.allowSeek,e.loop=null==e.loop?this.defaultOptions.loop:e.loop,e.speedOptions=null==e.speedOptions||0==e.speedOptions.length||""==e.speedOptions[0]?this.defaultOptions.speedOptions:e.speedOptions,null!=e.header?(e.header.title=null==e.header.title?this.defaultOptions.header.title:e.header.title,e.header.date=null==e.header.date?this.defaultOptions.header.date:e.header.date):e.header=this.defaultOptions.header,this.options=e),this.buildDOM()}else console.error("Video element requires at least one quality option")}buildDOM(){let e=this.source.src,t=this.options.poster,l=document.createElement("div");l.classList.add("video-player"),this.options.classes!=[""]&&this.options.classes!=[]&&0!=this.options.classes.length&&this.options.classes.forEach(e=>l.classList.add(e)),l.id=this.options.id;let s=document.createElement("video");s.src=e,null!=t&&(s.poster=t);let i=document.createElement("div");i.classList.add("controls");let o=document.createElement("div");o.classList.add("progress");let a=document.createElement("span");a.classList.add("preview");let n=document.createElement("span");n.classList.add("track");let d=document.createElement("span");d.classList.add("hover");let r=document.createElement("div");r.classList.add("row","control-buttons");let u=document.createElement("i");u.classList.add("play"),u.title="play/pause";let p=document.createElement("p");p.classList.add("4","video-track-timestamp");let c=document.createElement("span");c.classList.add("current-timestamp");let m=document.createElement("span");m.classList.add("total-timestamp");let h=document.createElement("i");h.classList.add("mute-button","fa-solid","fa-volume-up"),h.title="mute/unmute";let f=document.createElement("i");f.classList.add("fullscreen-btn","fa-solid","fa-expand"),f.title="toggle fullscreen";let v=document.createElement("i");return v.classList.add("options-btn","fa-solid","fa-gear"),v.title="options",v.setAttribute("tabindex","0"),o.appendChild(a),o.appendChild(n),o.appendChild(d),p.appendChild(c),p.append("/"),p.appendChild(m),r.appendChild(u),this.options.allowAudioModulation&&r.appendChild(h),r.appendChild(p),i.appendChild(o),i.appendChild(r),(this.options.qualityOptions.length>1||this.options.speedOptions!=[])&&i.appendChild(v),this.options.allowFullscreen&&i.appendChild(f),l.appendChild(s),l.appendChild(i),l.setAttribute("tabindex","0"),this.player=l,this.player}buildOptions(){let e=document.createElement("div");e.classList.add("options-body");let t=document.createElement("div");t.classList.add("speed-option","video-option"),t.innerText=`Speed (${1==this.speed?"normal":this.speed+"x"})`,t.title="change video playback speed",$(t).on("click",()=>{$(this.player).find(".options-body")[0].remove(),$(this.player).find(".options-btn")[0].appendChild(this.buildSpeedOptions())});let l=document.createElement("div");return l.classList.add("quality-option","video-option"),l.innerText=`Quality (${this.source.name})`,l.title="change video playback quality",this.options.qualityOptions.length>1&&e.appendChild(l),this.options.speedOptions!=[]&&e.appendChild(t),e}buildSpeedOptions(){let e=document.createElement("div");return e.classList.add("options-body"),this.options.speedOptions.forEach(t=>{let l=document.createElement("div");l.classList.add("video-option",`speed-option-${t}`),l.innerText=`${t}x`,e.appendChild(l),$(l).on("click",()=>{$(this.player).find("video")[0].playbackRate=t,this.speed=t,$(this.player).find(".options-btn")[0].blur()})}),e}buildResolutionOptions(){let e=document.createElement("div");e.classList.add("options-body");let t=document.createElement("div");return t.classList.add("video-option","back"),t.innerText="Back",this.options.qualityOptions.forEach(t=>{let l=document.createElement("div"),s=t.trim();l.classList.add("video-option",`quality-option-${s}`),l.innerText=`${s}x`,e.appendChild(l)}),e}replaceElement(e){e.outerHTML=this.player.outerHTML,this.player=$(`#${this.options.id}`)[0],this.buildEventListeners()}buildEventListeners(){function e(){y.allowFullscreen&&(document.fullscreen?document.exitFullscreen():d.requestFullscreen())}function t(){u.paused?l():(s(),o())}function l(){u.play(),p.classList.add("pause"),p.classList.remove("play"),h=setInterval(()=>o(),100),r=setInterval(()=>{a()},1e3)}function s(){u.pause(),p.classList.add("play"),p.classList.remove("pause"),n(),clearInterval(h),clearInterval(r)}function i(){s(),u.currentTime=0,o()}function o(){try{u.currentTime==u.duration&&(i(),y.loop&&l());let e=new Date(1e3*u.currentTime).toISOString().substr(11,8),t=new Date(1e3*u.duration).toISOString().substr(11,8),s=u.currentTime/u.duration*100;$(d).find(".current-timestamp")[0].innerText=e,$(d).find(".total-timestamp")[0].innerText=t,v||($(d).find(".progress .track")[0].style.maxWidth=`${s}%`)}catch{}}function a(){d.classList.remove("show")}function n(){d.classList.add("show")}let d=this.player,r=null,u=$(d).find("video")[0];u.paused&&n();let p=$(d).find(".play")[0],c=$(d).find(".fullscreen-btn")[0],m=$(d).find(".mute-button")[0],h=setInterval(()=>o(),100),f=$(d).find(".preview")[0],v=!1,y=this.options;f.style.display="none",$(d).find(".options-btn").on("focusin",()=>{let e=this.buildOptions();$(d).find(".options-btn")[0].appendChild(e)}),$(d).find(".options-btn").on("focusout",()=>{$(d).find(".options-body")[0].remove()}),$(p).on("click",()=>t()),$(u).on("click",()=>t()),$(u).on("dblclick",()=>e()),$(c).on("click",()=>e()),$(c).on("click",()=>e()),$(m).on("click",()=>{u.muted=!u.muted,u.muted?(m.classList.add("fa-volume-mute"),m.classList.remove("fa-volume-up")):(m.classList.add("fa-volume-up"),m.classList.remove("fa-volume-mute"))}),$(d).contextmenu(e=>{e.preventDefault()}),$(d).find(".progress").on("mousedown",()=>{y.allowSeek&&(v=!0)}),$(document).on("mouseup",e=>{if(v){v=!1;let t=$(d).find(".progress")[0].getBoundingClientRect(),l=(e.clientX-t.left)/t.width*100,s=l*u.duration/100;u.currentTime=s,$(d).find(".progress .track")[0].style.transition="unset",$(d).find(".progress .track")[0].style.maxWidth=`${l}%`,setTimeout(()=>{$(d).find(".progress .track")[0].style.transition=""},500)}}),$(document).on("mousemove",e=>{if(v){let t=$(d).find(".progress .track")[0],l=$(d).find(".progress")[0].getBoundingClientRect(),s=(e.clientX-l.left)/l.width*100;t.style.transition="unset",t.style.maxWidth=`${s}%`,setTimeout(()=>{t.style.transition=""},500),$(d).find(".progress .hover")[0].style.maxWidth=`${s}%`;let i=s*u.duration/100,o=new Date(1e3*i).toISOString().substr(11,8);f.innerText=o,f.style.display="",f.style.left=`calc(${s}% - ${f.getBoundingClientRect().width/2}px)`}}),y.allowKeyboardShortcuts&&$(d).on("keydown",l=>{switch(l.preventDefault(),l.key){case" ":t();break;case"f":e();break;case"m":y.allowAudioModulation&&(u.muted=!u.muted,u.muted?(m.classList.add("fa-volume-mute"),m.classList.remove("fa-volume-up")):(m.classList.add("fa-volume-up"),m.classList.remove("fa-volume-mute")));break;case"ArrowRight":y.allowSeek&&(u.currentTime>u.duration-10?i():u.currentTime+=10,o());break;case"ArrowLeft":y.allowSeek&&(10>u.currentTime?u.currentTime=0:u.currentTime-=10,o());break;case"ArrowDown":y.allowAudioModulation&&(.1>u.volume?(u.mute=!0,m.classList.add("fa-volume-mute"),m.classList.remove("fa-volume-up")):u.volume-=.1,o());break;case"ArrowUp":y.allowAudioModulation&&(u.mute=!1,u.volume>.9?u.volume=1:u.volume+=.1,m.classList.add("fa-volume-up"),m.classList.remove("fa-volume-mute"),o())}}),$(d).find(".progress").on("mouseleave",()=>{f.style.display="none",$(d).find(".progress .hover")[0].style.maxWidth="0%"}),$(u).on("mousemove",()=>{u.paused||(n(),null!=r&&clearInterval(r),r=setInterval(()=>{u.paused||a()},3e3))}),$(d).on("mouseleave",()=>{u.paused||a(),null!=r&&clearInterval(r)}),o()}}